<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Pixel Coordinates</title>
        <style>
            * {
                box-sizing: border-box;
            }
            body {
                font-family:
                    Helvetica,
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Arial,
                    sans-serif;
                line-height: 1.6;
                max-width: 980px;
                margin: 0 auto;
                padding: 20px;
                color: #24292e;
                background: #ffffff;
            }
            h1 {
                border-bottom: 1px solid #eaecef;
                padding-bottom: 0.3em;
                margin-top: 0;
                font-size: 32px;
                font-weight: 600;
            }
            .controls {
                display: flex;
                gap: 8px;
                align-items: center;
                margin-bottom: 16px;
                flex-wrap: wrap;
            }
            input[type="file"] {
                font-size: 16px;
                font-family:
                    Helvetica,
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Arial,
                    sans-serif;
                color: transparent;
                width: auto;
                display: none;
            }
            input[type="file"]::file-selector-button {
                margin-right: 0;
                padding: 6px 12px;
                background: #fafbfc;
                color: #24292e;
                border: 1px solid rgba(27, 31, 35, 0.15);
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-family:
                    Helvetica,
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Arial,
                    sans-serif;
            }
            input[type="file"]::file-selector-button:hover {
                background: #f3f4f6;
            }
            .btn {
                background: #0366d6;
                color: #fff;
                padding: 8px 12px;
                border-radius: 6px;
                border: 1px solid rgba(27, 31, 35, 0.15);
                cursor: pointer;
                font-size: 14px;
                line-height: 20px;
                text-decoration: none;
                font-family:
                    Helvetica,
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Arial,
                    sans-serif;
            }
            .btn:hover {
                background: #0256c5;
            }
            .btn.secondary {
                background: #fafbfc;
                color: #24292e;
                border: 1px solid rgba(27, 31, 35, 0.15);
            }
            .btn.secondary:hover {
                background: #f3f4f6;
            }
            .panel {
                background: #f6f8fa;
                padding: 16px;
                border-radius: 6px;
                border: 1px solid #e1e4e8;
                margin-bottom: 16px;
            }
            .viewer {
                position: relative;
                border-radius: 6px;
                overflow: hidden;
                border: 1px solid #e1e4e8;
                background: #ffffff;
                min-height: 300px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition:
                    border-color 0.2s,
                    background-color 0.2s;
            }
            .viewer.drag-over {
                border-color: #0366d6;
                border-width: 2px;
                background: #f0f7ff;
            }
            img#photo {
                display: block;
                max-width: 100%;
                height: auto;
                user-select: none;
            }
            .marker {
                position: absolute;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                transform: translate(-50%, -50%);
                background: #0366d6;
                border: 2px solid #ffffff;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
                cursor: pointer;
            }
            .marker:hover {
                background: #0256c5;
            }
            .marker-label {
                position: absolute;
                left: 100%;
                top: 50%;
                transform: translateY(-50%);
                margin-left: 6px;
                font-size: 12px;
                font-weight: 600;
                color: #24292e;
                text-shadow:
                    0 0 3px #ffffff,
                    0 0 3px #ffffff,
                    0 0 3px #ffffff;
                white-space: nowrap;
                pointer-events: none;
            }
            .options {
                margin-top: 12px;
                margin-bottom: 12px;
                padding: 12px;
                background: #ffffff;
                border-radius: 6px;
                border: 1px solid #e1e4e8;
            }
            label:not(.btn) {
                font-size: 14px;
                color: #24292e;
                cursor: pointer;
            }
            label.btn {
                display: inline-block;
            }
            label input[type="checkbox"] {
                margin-right: 6px;
            }
            .small {
                font-size: 14px;
                color: #24292e;
                margin-left: 8px;
                font-weight: 500;
            }
            textarea {
                width: 100%;
                height: 150px;
                font-family:
                    "SFMono-Regular", Consolas, "Liberation Mono", Menlo,
                    monospace;
                font-size: 14px;
                padding: 12px;
                border: 1px solid #e1e4e8;
                border-radius: 6px;
                background: #ffffff;
                color: #24292e;
                resize: vertical;
            }
            textarea:focus {
                outline: none;
                border-color: #0366d6;
            }
            .actions {
                margin-top: 12px;
                display: flex;
                gap: 8px;
                justify-content: flex-end;
            }
            .info {
                font-size: 13px;
                color: #586069;
                margin-top: 12px;
                padding: 12px;
                background: #f6f8fa;
                border-radius: 6px;
                border: 1px solid #e1e4e8;
            }
            .back-link {
                display: inline-block;
                margin-bottom: 16px;
                color: #0366d6;
                text-decoration: none;
                font-size: 14px;
            }
            .back-link:hover {
                text-decoration: underline;
            }
        </style>
    </head>
    <body>
        <a href="index.html" class="back-link">‚Üê Back to Browser Tools</a>

        <h1>Pixel Coordinates</h1>

        <div
            class="options"
            style="
                display: flex;
                align-items: center;
                gap: 0;
                margin-bottom: 16px;
            "
        >
            <input
                id="file"
                type="file"
                accept="image/*"
                style="display: none"
            />
            <label for="file" class="btn">Browse</label>
            <span id="file-status" class="small" style="margin-left: 8px"
                >No file selected</span
            >
            <button
                id="clearImage"
                class="btn secondary"
                style="margin-left: auto"
            >
                Clear image
            </button>
        </div>

        <div class="panel">
            <div class="viewer" id="viewer" style="cursor: not-allowed">
                <img
                    id="photo"
                    alt="Browse, drag and drop, or paste an image to begin"
                    src=""
                />
            </div>
        </div>

        <div
            class="options"
            style="
                display: flex;
                align-items: center;
                gap: 8px;
                margin-top: 16px;
            "
        >
            <button id="undo" class="btn secondary">Undo last</button>
            <button id="clear" class="btn secondary">Clear points</button>
            <span class="small" style="margin-left: 8px">
                Click on the image to add points. Markers are numbered. Click a
                marker to remove it.
            </span>
        </div>

        <div
            style="
                margin-top: 10px;
                display: flex;
                gap: 12px;
                align-items: center;
                flex-wrap: wrap;
            "
        >
            <label
                ><input id="coordsSpace" type="checkbox" checked /> Use natural
                image pixels for coordinates</label
            >
            <span class="small"
                >(if unchecked, coordinates are relative to displayed image
                size)</span
            >
        </div>

        <div class="panel" style="margin-top: 16px">
            <textarea id="output" readonly></textarea>

            <div class="actions">
                <button id="copy" class="btn">Copy to clipboard</button>
                <button id="download" class="btn">Download .json</button>
            </div>
        </div>

        <script type="module">
            const positions = [];
            const viewer = document.getElementById("viewer");
            const photo = document.getElementById("photo");
            const output = document.getElementById("output");
            const fileInput = document.getElementById("file");

            const fileStatus = document.getElementById("file-status");
            const undoBtn = document.getElementById("undo");
            const clearBtn = document.getElementById("clear");
            const clearImageBtn = document.getElementById("clearImage");
            const copyBtn = document.getElementById("copy");
            const downloadBtn = document.getElementById("download");
            const coordsSpaceCheckbox = document.getElementById("coordsSpace");

            fileInput.addEventListener("change", (e) => {
                const f = e.target.files && e.target.files[0];
                if (!f) {
                    fileStatus.textContent = "No file selected";
                    return;
                }
                loadImageFromFile(f);
            });

            function loadImageFromFile(file) {
                if (!file.type.startsWith("image/")) {
                    alert("Please select an image file");
                    return;
                }
                fileStatus.textContent = `Selected: ${file.name}`;
                const url = URL.createObjectURL(file);
                loadImage(url);
            }

            // Drag and drop functionality
            viewer.addEventListener("dragover", (e) => {
                e.preventDefault();
                e.stopPropagation();
                viewer.classList.add("drag-over");
            });

            viewer.addEventListener("dragleave", (e) => {
                e.preventDefault();
                e.stopPropagation();
                viewer.classList.remove("drag-over");
            });

            viewer.addEventListener("drop", (e) => {
                e.preventDefault();
                e.stopPropagation();
                viewer.classList.remove("drag-over");

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    loadImageFromFile(files[0]);
                }
            });

            // Paste from clipboard functionality
            document.addEventListener("paste", (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        e.preventDefault();
                        const file = items[i].getAsFile();
                        fileStatus.textContent = "Pasted from clipboard";
                        const url = URL.createObjectURL(file);
                        loadImage(url);
                        break;
                    }
                }
            });

            function loadImage(src) {
                clearAll();
                photo.src = src;
                photo.style.maxWidth = "100%";
                photo.addEventListener(
                    "load",
                    () => {
                        output.value = "";
                        viewer.style.minHeight = photo.clientHeight + "px";
                        viewer.style.cursor = "crosshair";
                    },
                    { once: true },
                );
            }

            function getImageCoordinates(clientX, clientY) {
                const rect = photo.getBoundingClientRect();
                const dx = clientX - rect.left;
                const dy = clientY - rect.top;
                const clampedX = Math.max(0, Math.min(rect.width, dx));
                const clampedY = Math.max(0, Math.min(rect.height, dy));

                if (
                    coordsSpaceCheckbox.checked &&
                    photo.naturalWidth &&
                    photo.naturalHeight
                ) {
                    const scaleX = photo.naturalWidth / rect.width;
                    const scaleY = photo.naturalHeight / rect.height;
                    return {
                        x: Math.round(clampedX * scaleX),
                        y: Math.round(clampedY * scaleY),
                    };
                }
                return { x: Math.round(clampedX), y: Math.round(clampedY) };
            }

            function addMarker(pos) {
                const m = document.createElement("div");
                m.className = "marker";
                m.style.left = coordsToDisplayX(pos.x) + "px";
                m.style.top = coordsToDisplayY(pos.y) + "px";
                m.title = `x: ${pos.x}, y: ${pos.y}`;

                const label = document.createElement("div");
                label.className = "marker-label";
                label.textContent =
                    positions.indexOf(pos) + 1 ||
                    document.querySelectorAll(".marker").length + 1;
                m.appendChild(label);

                m.addEventListener("click", (ev) => {
                    ev.stopPropagation();
                    const idx = Array.from(
                        document.querySelectorAll(".marker"),
                    ).indexOf(m);
                    if (idx >= 0) {
                        positions.splice(idx, 1);
                        m.remove();
                        refreshMarkers();
                        renderOutput();
                    }
                });
                viewer.appendChild(m);
            }

            function coordsToDisplayX(x) {
                const rect = photo.getBoundingClientRect();
                const viewerRect = viewer.getBoundingClientRect();
                const offsetX = rect.left - viewerRect.left;

                if (
                    coordsSpaceCheckbox.checked &&
                    photo.naturalWidth &&
                    photo.clientWidth
                ) {
                    return (
                        offsetX +
                        Math.round((x / photo.naturalWidth) * photo.clientWidth)
                    );
                }
                return offsetX + x;
            }

            function coordsToDisplayY(y) {
                const rect = photo.getBoundingClientRect();
                const viewerRect = viewer.getBoundingClientRect();
                const offsetY = rect.top - viewerRect.top;

                if (
                    coordsSpaceCheckbox.checked &&
                    photo.naturalHeight &&
                    photo.clientHeight
                ) {
                    return (
                        offsetY +
                        Math.round(
                            (y / photo.naturalHeight) * photo.clientHeight,
                        )
                    );
                }
                return offsetY + y;
            }

            function refreshMarkers() {
                document.querySelectorAll(".marker").forEach((n) => n.remove());
                positions.forEach((p, i) => {
                    const m = document.createElement("div");
                    m.className = "marker";
                    m.style.left = coordsToDisplayX(p.x) + "px";
                    m.style.top = coordsToDisplayY(p.y) + "px";
                    m.title = `x: ${p.x}, y: ${p.y}`;

                    const label = document.createElement("div");
                    label.className = "marker-label";
                    label.textContent = i + 1;
                    m.appendChild(label);

                    m.addEventListener("click", (ev) => {
                        ev.stopPropagation();
                        positions.splice(i, 1);
                        refreshMarkers();
                        renderOutput();
                    });
                    viewer.appendChild(m);
                });
            }

            function renderOutput() {
                if (positions.length === 0) {
                    output.value =
                        "// No positions yet. Click the image to add points.";
                    return;
                }
                let s = "const positions = [\n";
                positions.forEach((p) => {
                    s += `  { x: ${p.x}, y: ${p.y} },\n`;
                });
                s += "];";
                output.value = s;
            }

            function clearAll() {
                positions.length = 0;
                document.querySelectorAll(".marker").forEach((n) => n.remove());
                renderOutput();
            }

            function clearImage() {
                clearAll();
                photo.src = "";
                viewer.style.cursor = "not-allowed";
                viewer.style.minHeight = "300px";
                fileStatus.textContent = "No file selected";
                fileInput.value = "";
            }

            function undoLast() {
                positions.pop();
                refreshMarkers();
                renderOutput();
            }

            async function copyToClipboard() {
                try {
                    await navigator.clipboard.writeText(output.value);
                    copyBtn.textContent = "Copied!";
                    setTimeout(
                        () => (copyBtn.textContent = "Copy to clipboard"),
                        900,
                    );
                } catch (e) {
                    alert(
                        "Could not copy automatically. You can select the text and copy.",
                    );
                }
            }

            function downloadJSON() {
                const blob = new Blob([JSON.stringify(positions, null, 2)], {
                    type: "application/json",
                });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = "positions.json";
                document.body.appendChild(a);
                a.click();
                a.remove();
            }

            viewer.addEventListener("click", (ev) => {
                if (!photo.src || !photo.complete || photo.naturalWidth === 0) {
                    return;
                }
                const pos = getImageCoordinates(ev.clientX, ev.clientY);
                positions.push(pos);
                addMarker(pos);
                refreshMarkers();
                renderOutput();
            });

            undoBtn.addEventListener("click", () => {
                undoLast();
            });

            clearBtn.addEventListener("click", () => {
                if (confirm("Clear all points?")) clearAll();
            });

            clearImageBtn.addEventListener("click", () => {
                if (confirm("Clear the current image and all points?"))
                    clearImage();
            });

            copyBtn.addEventListener("click", () => {
                copyToClipboard();
            });

            downloadBtn.addEventListener("click", () => {
                downloadJSON();
            });

            window.addEventListener("resize", () => refreshMarkers());
            coordsSpaceCheckbox.addEventListener("change", () =>
                refreshMarkers(),
            );

            renderOutput();
        </script>
    </body>
</html>
