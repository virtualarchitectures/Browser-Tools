<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Named Entity Recognition</title>
    <style>
      /* =========================
         CSS Styles
         ========================= */

      :root {
        --primary-color: #0366d6;
        --bg-color: #f6f8fa;
        --border-color: #e1e4e8;
        --text-color: #24292e;
        --secondary-text: #586069;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica,
          Arial, sans-serif;
        line-height: 1.6;
        color: var(--text-color);
        margin: 0;
        padding: 20px;
        background-color: #fff;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .back-link {
        display: inline-block;
        margin-bottom: 16px;
        color: #0366d6;
        text-decoration: none;
        font-size: 14px;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      header {
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1rem;
      }

      h1 {
        margin: 0 0 8px 0;
        font-size: 1.5rem;
      }

      header p {
        margin: 0;
        color: var(--secondary-text);
        font-size: 14px;
      }

      .input-section {
        display: grid;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .file-controls {
        display: flex;
        align-items: center;
        gap: 0;
        padding: 12px;
        background: #ffffff;
        border-radius: 6px;
        border: 1px solid var(--border-color);
      }

      .file-status {
        font-size: 14px;
        color: var(--text-color);
        margin-left: 8px;
        font-weight: 500;
      }

      textarea {
        width: 100%;
        height: 200px;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        box-sizing: border-box;
      }

      textarea:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      .controls {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .btn,
      button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        font-family: inherit;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }

      .btn:hover,
      button:hover {
        opacity: 0.9;
      }

      .btn.secondary,
      button.secondary {
        background-color: #eff3f6;
        color: var(--text-color);
        border: 1px solid rgba(27, 31, 35, 0.15);
      }

      .btn.secondary:hover,
      button.secondary:hover {
        background: #f3f4f6;
        opacity: 1;
      }

      label.btn {
        margin: 0;
      }

      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        padding: 1rem;
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        text-align: center;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        line-height: 1;
      }

      .stat-label {
        font-size: 0.875rem;
        color: var(--secondary-text);
        margin-top: 0.5rem;
        font-weight: 500;
      }

      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: var(--bg-color);
        border-radius: 6px;
        border: 1px solid var(--border-color);
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
      }

      .legend-color.person {
        background-color: #d4edff;
      }

      .legend-color.place {
        background-color: #dcffe4;
      }

      .legend-color.organization {
        background-color: #fff5d4;
      }

      .legend-color.date {
        background-color: #ffe4f5;
      }

      .legend-color.value {
        background-color: #e4f5ff;
      }

      .highlighted-text {
        padding: 1.5rem;
        background-color: #fafbfc;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        margin-bottom: 2rem;
        line-height: 1.8;
        font-size: 14px;
        max-height: 400px;
        overflow-y: auto;
      }

      .highlight {
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: 500;
        cursor: help;
      }

      .highlight.person {
        background-color: #d4edff;
        color: #0550ae;
      }

      .highlight.place {
        background-color: #dcffe4;
        color: #0f6e27;
      }

      .highlight.organization {
        background-color: #fff5d4;
        color: #7d4e00;
      }

      .highlight.date {
        background-color: #ffe4f5;
        color: #a0095b;
      }

      .highlight.value {
        background-color: #e4f5ff;
        color: #0969da;
      }

      .results-section {
        margin-top: 2rem;
      }

      .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-color);
      }

      .entities-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .table-container {
        border: 1px solid var(--border-color);
        border-radius: 6px;
        overflow: hidden;
      }

      .table-header {
        background-color: var(--bg-color);
        padding: 10px 15px;
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 40px;
      }

      .table-header h3 {
        margin: 0;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .entity-badge {
        background-color: var(--primary-color);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .table-search {
        padding: 10px 15px;
        background-color: #ffffff;
        border-bottom: 1px solid var(--border-color);
      }

      .table-search input {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        box-sizing: border-box;
      }

      .table-search input:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      th,
      td {
        padding: 8px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }

      th {
        background-color: #fafbfc;
        font-weight: 600;
        color: var(--secondary-text);
      }

      td.count-cell {
        text-align: right;
        font-weight: 600;
        color: var(--primary-color);
        width: 100px;
      }

      tr:last-child td {
        border-bottom: none;
      }

      tr:hover {
        background-color: #f6f8fa;
      }

      .empty-state {
        padding: 3rem;
        text-align: center;
        color: var(--secondary-text);
        background-color: var(--bg-color);
        border-radius: 6px;
        border: 1px solid var(--border-color);
      }

      .loading {
        display: none;
        padding: 1rem;
        text-align: center;
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 6px;
        margin-bottom: 1rem;
        color: #856404;
        font-weight: 500;
      }

      .loading.visible {
        display: block;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .entities-grid {
          grid-template-columns: 1fr;
        }

        .legend {
          flex-direction: column;
        }

        td,
        th {
          padding: 6px 10px;
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- =========================
         HTML Structure
         ========================= -->

    <div class="container">
      <a href="index.html" class="back-link">‚Üê Back to Browser Tools</a>

      <header>
        <h1>Named Entity Recognition</h1>
        <p>
          Extract and identify named entities from text including people,
          places, organisations, dates and values using natural language
          processing. All processing happens locally in your browser.
        </p>
      </header>

      <div class="input-section">
        <div class="file-controls">
          <input
            type="file"
            id="fileInput"
            accept=".txt,.md,.csv,.html"
            style="display: none"
          />
          <label for="fileInput" class="btn">Load File</label>
          <span id="fileStatus" class="file-status">No file selected</span>
          <button
            id="clearFileBtn"
            class="btn secondary"
            style="margin-left: auto"
          >
            Clear
          </button>
        </div>

        <textarea
          id="textInput"
          placeholder="Or paste your text here... Example: John Smith visited Apple headquarters in Cupertino, California on January 15th, 2024. He met with Tim Cook to discuss a $5 million partnership deal."
        ></textarea>

        <div class="controls">
          <button id="analyzeBtn">Analyze</button>
        </div>
      </div>

      <div class="loading" id="loading">Analyzing text...</div>

      <div id="statsSection">
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">Total Entities</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">People</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">Places</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">Organizations</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">Dates</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">Values/Money</div>
          </div>
        </div>
      </div>

      <div id="highlightedSection">
        <h2 class="section-title">Highlighted Text</h2>
        <div id="legendSection">
          <div class="legend">
            <div class="legend-item">
              <div class="legend-color person"></div>
              <span>People</span>
            </div>
            <div class="legend-item">
              <div class="legend-color place"></div>
              <span>Places</span>
            </div>
            <div class="legend-item">
              <div class="legend-color organization"></div>
              <span>Organizations</span>
            </div>
            <div class="legend-item">
              <div class="legend-color date"></div>
              <span>Dates</span>
            </div>
            <div class="legend-item">
              <div class="legend-color value"></div>
              <span>Values/Money</span>
            </div>
          </div>
        </div>
        <div class="highlighted-text" id="highlightedText">
          <p style="color: var(--secondary-text); font-style: italic">
            Your text will appear here with highlighted entities...
          </p>
        </div>
      </div>

      <div id="entitiesSection">
        <h2 class="section-title">Extracted Entities</h2>
        <div id="entitiesContainer" class="entities-grid">
          <div class="empty-state">
            Enter or load text and click "Analyze" to extract named entities.
          </div>
        </div>
      </div>
    </div>

    <!-- Compromise.js library -->
    <script src="https://cdn.jsdelivr.net/npm/compromise@14.13.0/builds/compromise.min.js"></script>

    <script>
      /* =========================
         JavaScript
         ========================= */

      // State variables
      let currentAnalysis = null;

      // DOM elements
      const fileInput = document.getElementById("fileInput");
      const fileStatus = document.getElementById("fileStatus");
      const clearFileBtn = document.getElementById("clearFileBtn");
      const textInput = document.getElementById("textInput");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const loading = document.getElementById("loading");
      const statsSection = document.getElementById("statsSection");
      const statsGrid = document.getElementById("statsGrid");
      const legendSection = document.getElementById("legendSection");
      const highlightedSection = document.getElementById("highlightedSection");
      const highlightedText = document.getElementById("highlightedText");
      const entitiesSection = document.getElementById("entitiesSection");
      const entitiesContainer = document.getElementById("entitiesContainer");

      // Event listeners
      fileInput.addEventListener("change", handleFile);
      clearFileBtn.addEventListener("click", clearFile);
      analyzeBtn.addEventListener("click", analyzeText);

      // File handling
      function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          textInput.value = event.target.result;
          fileStatus.textContent = file.name;
        };
        reader.readAsText(file);
      }

      function clearFile() {
        fileInput.value = "";
        fileStatus.textContent = "No file selected";
        textInput.value = "";
        resetToPlaceholder();
      }

      function resetToPlaceholder() {
        // Reset stats to zeros
        statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Total Entities</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">People</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Places</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Organizations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Dates</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Values/Money</div>
                    </div>
                `;

        // Reset highlighted text
        highlightedText.innerHTML = `
                    <p style="color: var(--secondary-text); font-style: italic">
                        Your analyzed text will appear here with highlighted
                        entities...
                    </p>
                `;

        // Reset entities container
        entitiesContainer.innerHTML = `
                    <div class="empty-state">
                        Enter or load text and click "Analyze" to extract named
                        entities.
                    </div>
                `;
      }

      // Get unique entities with counts
      // Normalize a single entity by removing possessives and punctuation
      function normalizeEntity(entity) {
        let normalized = entity.trim();

        // Remove possessive 's or 'S (multiple passes to handle edge cases)
        for (let i = 0; i < 3; i++) {
          normalized = normalized
            .replace(/[^\w\s][sS]$/, "") // Any punctuation + s/S at end
            .replace(/\u2019[sS]$/, "") // Right single quote (common)
            .replace(/\u0027[sS]$/, "") // Standard apostrophe
            .trim();
        }

        // Remove any trailing/leading whitespace and punctuation (multiple passes)
        for (let i = 0; i < 3; i++) {
          normalized = normalized
            .replace(/^[^\w]+/, "") // Leading punctuation
            .replace(/[^\w]+$/, "") // Trailing punctuation and spaces
            .trim();
        }

        return normalized;
      }

      function getEntityCounts(entities) {
        const counts = {};
        entities.forEach((entity) => {
          const normalized = normalizeEntity(entity);
          const key = normalized.toLowerCase();
          if (key) {
            // Only count if there's something left after normalization
            if (!counts[key]) {
              counts[key] = { name: normalized, count: 0 };
            }
            counts[key].count++;
          }
        });

        return Object.entries(counts)
          .map(([key, data]) => ({
            entity: data.name,
            count: data.count,
          }))
          .sort((a, b) => b.count - a.count);
      }

      // Create entity table
      function createEntityTable(title, entities, type) {
        if (entities.length === 0) return "";

        const entityCounts = getEntityCounts(entities);
        const totalCount = entityCounts.reduce(
          (sum, item) => sum + item.count,
          0
        );

        const container = document.createElement("div");
        container.className = "table-container";

        // Create unique IDs for this table
        const tableId = `table-${type}`;
        const searchId = `search-${type}`;
        const downloadId = `download-${type}`;

        container.innerHTML = `
          <div class="table-header">
            <h3>${title} <span class="entity-badge">${
          entityCounts.length
        } unique</span></h3>
            <button
              id="${downloadId}"
              class="btn"
              style="padding: 4px 8px; font-size: 12px; margin-left: auto"
              title="Download as CSV"
            >
              CSV
            </button>
          </div>
          <div class="table-search">
            <input
              type="text"
              id="${searchId}"
              placeholder="Search ${title.toLowerCase()}..."
            />
          </div>
          <div style="max-height: 300px; overflow-y: auto">
            <table id="${tableId}">
              <thead>
                <tr>
                  <th>Entity</th>
                  <th style="text-align: right; width: 100px">Count</th>
                </tr>
              </thead>
              <tbody>
                ${entityCounts
                  .map(
                    ({ entity, count }) => `
                  <tr>
                    <td>${escapeHtml(entity)}</td>
                    <td class="count-cell">${count}</td>
                  </tr>
                `
                  )
                  .join("")}
              </tbody>
            </table>
          </div>
        `;

        // Add event listeners after the element is added to the DOM
        setTimeout(() => {
          const searchInput = document.getElementById(searchId);
          const downloadBtn = document.getElementById(downloadId);

          if (searchInput) {
            searchInput.addEventListener("input", (e) => {
              filterTable(tableId, e.target.value);
            });
          }

          if (downloadBtn) {
            downloadBtn.addEventListener("click", () => {
              downloadCSV(tableId, `${type}-entities.csv`, ["Entity", "Count"]);
            });
          }
        }, 0);

        return container;
      }

      // Filter table rows based on search term
      function filterTable(tableId, searchTerm) {
        const table = document.getElementById(tableId);
        if (!table) return;

        const rows = table.querySelectorAll("tbody tr");
        const term = searchTerm.toLowerCase();

        rows.forEach((row) => {
          const firstCell = row.cells[0];
          if (firstCell) {
            const text = firstCell.textContent.toLowerCase();
            if (text.includes(term)) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          }
        });
      }

      // Download table as CSV
      function downloadCSV(tableId, filename, headers) {
        const table = document.getElementById(tableId);
        if (!table) return;

        const rows = table.querySelectorAll("tbody tr");

        // Build CSV content
        let csvContent = headers.join(",") + "\n";

        rows.forEach((row) => {
          const cells = Array.from(row.cells);
          const rowData = cells.map((cell) => {
            let value = cell.textContent.trim();
            // Escape quotes and wrap in quotes if contains comma
            if (value.includes(",") || value.includes('"')) {
              value = '"' + value.replace(/"/g, '""') + '"';
            }
            return value;
          });
          csvContent += rowData.join(",") + "\n";
        });

        downloadFile(csvContent, filename, "text/csv");
      }

      // Download file helper
      function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      // Highlight text with entities
      function highlightTextWithEntities(text, analysis) {
        // Collect all entities with their positions
        const allEntities = [
          ...analysis.people.map((e) => ({
            text: e,
            type: "person",
          })),
          ...analysis.places.map((e) => ({ text: e, type: "place" })),
          ...analysis.organizations.map((e) => ({
            text: e,
            type: "organization",
          })),
          ...analysis.dates.map((e) => ({ text: e, type: "date" })),
          ...analysis.values.map((e) => ({ text: e, type: "value" })),
        ];

        // Remove duplicates and sort by length (longest first) to avoid partial replacements
        const uniqueEntities = [];
        const seen = new Set();

        allEntities.forEach((entity) => {
          const key = `${entity.text.toLowerCase()}_${entity.type}`;
          if (!seen.has(key)) {
            seen.add(key);
            uniqueEntities.push(entity);
          }
        });

        uniqueEntities.sort((a, b) => b.text.length - a.text.length);

        // Create a map of positions to avoid overlapping highlights
        const positions = [];

        uniqueEntities.forEach(({ text: entityText, type }) => {
          // Escape special regex characters
          const escapedText = entityText.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
          const regex = new RegExp(`\\b${escapedText}\\b`, "gi");

          let match;
          while ((match = regex.exec(text)) !== null) {
            const start = match.index;
            const end = start + match[0].length;

            // Check if this position overlaps with existing highlights
            const overlaps = positions.some(
              (pos) =>
                (start >= pos.start && start < pos.end) ||
                (end > pos.start && end <= pos.end) ||
                (start <= pos.start && end >= pos.end)
            );

            if (!overlaps) {
              positions.push({
                start,
                end,
                text: match[0],
                type,
              });
            }
          }
        });

        // Sort positions by start index
        positions.sort((a, b) => a.start - b.start);

        // Build highlighted HTML
        let highlightedHTML = "";
        let lastIndex = 0;

        positions.forEach(({ start, end, text: matchText, type }) => {
          // Add text before the match
          highlightedHTML += escapeHtml(text.substring(lastIndex, start));
          // Add highlighted match
          highlightedHTML += `<span class="highlight ${type}" title="${type}: ${escapeHtml(
            matchText
          )}">${escapeHtml(matchText)}</span>`;
          lastIndex = end;
        });

        // Add remaining text
        highlightedHTML += escapeHtml(text.substring(lastIndex));

        return highlightedHTML;
      }

      // Analyze text function
      function analyzeText() {
        const text = textInput.value.trim();

        if (!text) {
          alert("Please enter some text to analyze.");
          return;
        }

        // Show loading state
        loading.classList.add("visible");

        // Use setTimeout to allow UI to update
        setTimeout(() => {
          try {
            // Parse text with Compromise
            const doc = nlp(text);

            // Extract entities
            let people = [];
            let places = [];
            let organizations = [];
            let dates = [];
            let values = [];

            // Extract people
            try {
              const peopleTerms = doc.people();
              if (peopleTerms && peopleTerms.out) {
                people = peopleTerms
                  .out("array")
                  .map((p) => normalizeEntity(p))
                  .filter((p) => p.length > 0);
              }
            } catch (e) {
              console.warn("Could not extract people:", e);
            }

            // Extract places
            try {
              const placeTerms = doc.places();
              if (placeTerms && placeTerms.out) {
                places = placeTerms
                  .out("array")
                  .map((p) => normalizeEntity(p))
                  .filter((p) => p.length > 0);
              }
            } catch (e) {
              console.warn("Could not extract places:", e);
            }

            // Extract organizations
            try {
              const orgTerms = doc.organizations();
              if (orgTerms && orgTerms.out) {
                organizations = orgTerms
                  .out("array")
                  .map((o) => normalizeEntity(o))
                  .filter((o) => o.length > 0);
              }
            } catch (e) {
              console.warn("Could not extract organizations:", e);
            }

            // Extract dates
            try {
              const datePatterns = [
                // Month DD, YYYY or Month DD YYYY
                /\b(?:January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2}(?:st|nd|rd|th)?,?\s+\d{4}/gi,
                // MM/DD/YYYY or MM/DD/YY
                /\b\d{1,2}\/\d{1,2}\/\d{2,4}\b/g,
                // YYYY-MM-DD
                /\b\d{4}-\d{2}-\d{2}\b/g,
                // DD Month YYYY
                /\b\d{1,2}(?:st|nd|rd|th)?\s+(?:January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{4}/gi,
                // Month YYYY
                /\b(?:January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{4}/gi,
                // Just year when it appears to be a date reference (2020-2024 range for modern dates)
                /\b(19\d{2}|20[0-2]\d)\b/g,
              ];

              const allDateMatches = [];
              datePatterns.forEach((pattern) => {
                const matches = text.match(pattern);
                if (matches) {
                  allDateMatches.push(...matches);
                }
              });

              if (allDateMatches.length > 0) {
                dates = allDateMatches;
              }
            } catch (e) {
              console.warn("Could not extract dates:", e);
            }

            // Extract money/values
            try {
              const moneyMatches = text.match(
                /\$[\d,]+(?:\.\d{2})?(?:\s*(?:million|billion|thousand|k|m|b))?|\b\d+(?:,\d{3})*(?:\.\d{2})?\s*(?:dollars|USD|EUR|GBP)/gi
              );
              if (moneyMatches) {
                values = moneyMatches;
              }
            } catch (e) {
              console.warn("Could not extract values:", e);
            }

            // Store analysis
            currentAnalysis = {
              text,
              people,
              places,
              organizations,
              dates,
              values,
            };

            // Display results
            displayResults(currentAnalysis);

            // Hide loading
            loading.classList.remove("visible");
          } catch (error) {
            console.error("Analysis error:", error);
            alert(
              "An error occurred during analysis. Please check the console for details."
            );
            loading.classList.remove("visible");
          }
        }, 100);
      }

      // Display results
      function displayResults(analysis) {
        const totalEntities =
          analysis.people.length +
          analysis.places.length +
          analysis.organizations.length +
          analysis.dates.length +
          analysis.values.length;

        // Display stats
        const uniquePeople = new Set(
          analysis.people.map((p) => p.toLowerCase())
        ).size;
        const uniquePlaces = new Set(
          analysis.places.map((p) => p.toLowerCase())
        ).size;
        const uniqueOrgs = new Set(
          analysis.organizations.map((o) => o.toLowerCase())
        ).size;
        const uniqueDates = new Set(analysis.dates.map((d) => d.toLowerCase()))
          .size;
        const uniqueValues = new Set(
          analysis.values.map((v) => v.toLowerCase())
        ).size;

        statsGrid.innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${totalEntities}</div>
            <div class="stat-label">Total Entities</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${uniquePeople}</div>
            <div class="stat-label">People</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${uniquePlaces}</div>
            <div class="stat-label">Places</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${uniqueOrgs}</div>
            <div class="stat-label">Organizations</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${uniqueDates}</div>
            <div class="stat-label">Dates</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${uniqueValues}</div>
            <div class="stat-label">Values</div>
          </div>
        `;

        // Display highlighted text
        highlightedText.innerHTML = highlightTextWithEntities(
          analysis.text,
          analysis
        );

        // Display entity tables
        entitiesContainer.innerHTML = "";

        if (totalEntities === 0) {
          entitiesContainer.innerHTML = `
                <div class="empty-state">
                  No entities were detected in the text. Try entering text with names, places, organizations, or dates.
                </div>
              `;
          return;
        }

        const sections = [
          {
            title: "People",
            entities: analysis.people,
            type: "people",
          },
          {
            title: "Places",
            entities: analysis.places,
            type: "places",
          },
          {
            title: "Organizations",
            entities: analysis.organizations,
            type: "organizations",
          },
          {
            title: "Dates",
            entities: analysis.dates,
            type: "dates",
          },
          {
            title: "Values/Money",
            entities: analysis.values,
            type: "values",
          },
        ];

        sections.forEach(({ title, entities, type }) => {
          if (entities.length > 0) {
            const table = createEntityTable(title, entities, type);
            entitiesContainer.appendChild(table);
          }
        });
      }

      // Utility function to escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
