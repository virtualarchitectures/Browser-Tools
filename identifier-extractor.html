<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Identifier Extractor</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Helvetica, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Arial, sans-serif;
        line-height: 1.6;
        max-width: 980px;
        margin: 0 auto;
        padding: 20px;
        color: #24292e;
        background: #ffffff;
      }
      h1 {
        border-bottom: 1px solid #eaecef;
        padding-bottom: 0.3em;
        margin-top: 0;
        font-size: 32px;
        font-weight: 600;
      }
      .back-link {
        display: inline-block;
        margin-bottom: 16px;
        color: #0366d6;
        text-decoration: none;
        font-size: 14px;
      }
      .back-link:hover {
        text-decoration: underline;
      }
      .instruction {
        font-size: 13px;
        color: #586069;
        margin-bottom: 16px;
        padding: 12px;
        background: #f6f8fa;
        border-radius: 6px;
        border: 1px solid #e1e4e8;
      }
      .input-section {
        margin-bottom: 24px;
      }
      .file-upload {
        margin-bottom: 16px;
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
      }
      .file-upload-left {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .file-upload input[type="file"] {
        display: none;
      }
      .file-upload label {
        display: inline-block;
        padding: 8px 16px;
        background: #0366d6;
        color: #fff;
        border: 1px solid rgba(27, 31, 35, 0.15);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        line-height: 20px;
        font-weight: 400;
        margin: 0;
        font-family: Helvetica, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Arial, sans-serif;
      }
      .file-upload label:hover {
        background: #0256c5;
      }
      .file-name {
        font-size: 13px;
        color: #586069;
      }
      label {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
        color: #24292e;
      }
      textarea {
        width: 100%;
        min-height: 200px;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo,
          monospace;
        font-size: 14px;
        padding: 12px;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        background: #ffffff;
        color: #24292e;
        resize: vertical;
      }
      textarea:focus {
        outline: none;
        border-color: #0366d6;
      }
      .options {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin: 16px 0;
        padding: 12px;
        background: #f6f8fa;
        border-radius: 6px;
        border: 1px solid #e1e4e8;
      }
      .options-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 4px;
      }
      .options-controls {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .sort-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .sort-group label {
        margin: 0;
        font-weight: 400;
      }
      .sort-group select {
        padding: 4px 8px;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        background: #ffffff;
        font-size: 14px;
        cursor: pointer;
      }
      .sort-group select:focus {
        outline: none;
        border-color: #0366d6;
      }
      .option-group {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .option-group input[type="checkbox"] {
        cursor: pointer;
      }
      .option-group label {
        margin: 0;
        font-weight: 400;
        cursor: pointer;
      }
      .button-section {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
      }
      button {
        background: #0366d6;
        color: #fff;
        padding: 8px 16px;
        border-radius: 6px;
        border: 1px solid rgba(27, 31, 35, 0.15);
        cursor: pointer;
        font-size: 14px;
        line-height: 20px;
        font-family: Helvetica, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Arial, sans-serif;
      }
      button:hover {
        background: #0256c5;
      }
      button.secondary {
        background: #fafbfc;
        color: #24292e;
      }
      button.secondary:hover {
        background: #f3f4f6;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .results-section {
        margin-top: 24px;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: 6px;
        margin-bottom: 16px;
        padding: 12px;
        background: #f6f8fa;
        border-radius: 6px;
        border: 1px solid #e1e4e8;
      }
      .stat-item {
        text-align: center;
      }
      .stat-number {
        font-size: 18px;
        font-weight: 600;
      }
      .stat-number .total {
        color: #0366d6;
      }
      .stat-number .selected {
        color: #586069;
      }
      .stat-number .arrow {
        margin: 0 2px;
        color: #d1d5da;
        font-size: 16px;
      }
      .stat-label {
        font-size: 12px;
        color: #586069;
        margin-top: 4px;
      }
      .links-container {
        background: #f6f8fa;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        padding: 16px;
        max-height: 500px;
        overflow-y: auto;
        margin-top: 16px;
      }
      .links-table {
        width: 100%;
        border-collapse: collapse;
        background: #ffffff;
        border-radius: 6px;
        overflow: hidden;
      }
      .links-table th {
        background: #f6f8fa;
        padding: 8px 12px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        color: #24292e;
        border-bottom: 1px solid #e1e4e8;
      }
      .links-table td {
        padding: 8px 12px;
        border-bottom: 1px solid #e1e4e8;
        font-size: 13px;
      }
      .links-table tr:last-child td {
        border-bottom: none;
      }
      .links-table tr:hover {
        background: #f6f8fa;
      }
      .link-url {
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo,
          monospace;
        color: #0366d6;
        word-break: break-all;
      }
      .link-type {
        color: #586069;
        font-size: 12px;
      }
      .link-actions {
        display: flex;
        gap: 4px;
        flex-shrink: 0;
      }
      .link-actions button {
        padding: 4px 8px;
        font-size: 12px;
        background: #fafbfc;
        color: #24292e;
      }
      .link-actions button:hover {
        background: #f3f4f6;
      }
      .empty-state {
        text-align: center;
        padding: 40px;
        color: #586069;
        font-size: 14px;
      }
      .hidden {
        display: none;
      }
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        background: #28a745;
        color: #ffffff;
        border-radius: 6px;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
        font-size: 14px;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
      }
      .notification.error {
        background: #d73a49;
      }
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @media (max-width: 768px) {
        body {
          padding: 12px;
        }
        .button-section {
          flex-direction: column;
        }
        button {
          width: 100%;
        }
        .stats {
          flex-direction: column;
        }
        .link-item {
          flex-direction: column;
          align-items: flex-start;
        }
        .link-actions {
          width: 100%;
          justify-content: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <a href="index.html" class="back-link">← Back to Browser Tools</a>

    <h1>Identifier Extractor</h1>

    <p class="instruction">
      Extract and analyse various types of identifiers from text including URLs,
      email addresses, IPv4/IPv6 addresses, phone numbers, and MAC addresses.
      Paste or load text below to automatically detect and extract all matching
      patterns. Filter by type, sort results, remove duplicates, and export to
      TXT or CSV format.
    </p>

    <div class="input-section">
      <div class="file-upload">
        <div class="file-upload-left">
          <input
            type="file"
            id="fileInput"
            accept=".txt,.html,.md,.csv,.json"
          />
          <label for="fileInput">Load File</label>
          <span class="file-name" id="fileName"></span>
        </div>
        <button class="secondary" id="clearBtn">Clear</button>
      </div>

      <label for="textInput">Or paste text directly</label>
      <textarea
        id="textInput"
        placeholder="Paste text containing URLs, emails, IP addresses, etc...

Examples:
Check out https://example.com for more info
Visit www.example.org or http://test.com
Email me at user@example.com
Server IP: 192.168.1.1
Phone: (555) 123-4567"
        autofocus
      ></textarea>
    </div>

    <div class="results-section hidden" id="resultsSection">
      <label>Results</label>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-number">
            <span class="total" id="totalItems">0</span>
          </div>
          <div class="stat-label">Total Items</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">
            <span class="total" id="uniqueItems">0</span>
          </div>
          <div class="stat-label">Unique Items</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">
            <span class="total" id="totalEmails">0</span>
            <span class="arrow">→</span>
            <span class="selected" id="selectedEmails">0</span>
          </div>
          <div class="stat-label">Emails</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">
            <span class="total" id="totalPhone">0</span>
            <span class="arrow">→</span>
            <span class="selected" id="selectedPhone">0</span>
          </div>
          <div class="stat-label">Phone</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">
            <span class="total" id="totalLinks">0</span>
            <span class="arrow">→</span>
            <span class="selected" id="selectedLinks">0</span>
          </div>
          <div class="stat-label">URLs</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">
            <span class="total" id="totalIPv4">0</span>
            <span class="arrow">→</span>
            <span class="selected" id="selectedIPv4">0</span>
          </div>
          <div class="stat-label">IPv4</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">
            <span class="total" id="totalIPv6">0</span>
            <span class="arrow">→</span>
            <span class="selected" id="selectedIPv6">0</span>
          </div>
          <div class="stat-label">IPv6</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">
            <span class="total" id="totalMAC">0</span>
            <span class="arrow">→</span>
            <span class="selected" id="selectedMAC">0</span>
          </div>
          <div class="stat-label">MAC</div>
        </div>
      </div>
    </div>

    <div class="options">
      <div class="options-row">
        <div class="option-group">
          <input type="checkbox" id="includeEmails" checked />
          <label for="includeEmails">Email</label>
        </div>
        <div class="option-group">
          <input type="checkbox" id="includePhone" checked />
          <label for="includePhone">Phone</label>
        </div>
        <div class="option-group">
          <input type="checkbox" id="includeLinks" checked />
          <label for="includeLinks">URL</label>
        </div>
        <div class="option-group">
          <input type="checkbox" id="includeIPv4" checked />
          <label for="includeIPv4">IPv4</label>
        </div>
        <div class="option-group">
          <input type="checkbox" id="includeIPv6" checked />
          <label for="includeIPv6">IPv6</label>
        </div>
        <div class="option-group">
          <input type="checkbox" id="includeMAC" checked />
          <label for="includeMAC">MAC</label>
        </div>
      </div>
      <div class="options-controls">
        <div class="sort-group">
          <label for="sortBy">Sort by:</label>
          <select id="sortBy">
            <option value="sequence">Sequence number</option>
            <option value="type">Type</option>
            <option value="value">Value</option>
          </select>
        </div>
        <div class="option-group">
          <input type="checkbox" id="removeDuplicates" />
          <label for="removeDuplicates">Remove duplicates</label>
        </div>
      </div>
    </div>

    <div class="results-section hidden" id="linksSection">
      <div class="button-section">
        <button id="copyAllBtn">Copy List</button>
        <button id="downloadTxtBtn">Download List</button>
        <button id="downloadCsvBtn">Download CSV</button>
      </div>

      <div class="links-container" id="linksContainer">
        <div class="empty-state">No items found in the text.</div>
      </div>
    </div>

    <script>
      /* =========================
         Detection Patterns
         ========================= */

      const PATTERNS = {
        url: {
          pattern:
            "https?:\\/\\/(?:www\\.)?[-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b(?:[-a-zA-Z0-9()@:%_\\+.~#?&\\/=]*[a-zA-Z0-9@:%_\\+~#?&\\/=])?",
          name: "URL",
          type: "link",
        },
        email: {
          pattern: "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}",
          name: "EMAIL",
          type: "email",
        },
        ipv4: {
          pattern:
            "\\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\b",
          name: "IPV4",
          type: "ipv4",
        },
        ipv6: {
          pattern:
            "(?:(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|(?:[0-9a-fA-F]{1,4}:){1,7}:|(?:[0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|(?:[0-9a-fA-F]{1,4}:){1,5}(?::[0-9a-fA-F]{1,4}){1,2}|(?:[0-9a-fA-F]{1,4}:){1,4}(?::[0-9a-fA-F]{1,4}){1,3}|(?:[0-9a-fA-F]{1,4}:){1,3}(?::[0-9a-fA-F]{1,4}){1,4}|(?:[0-9a-fA-F]{1,4}:){1,2}(?::[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:(?::[0-9a-fA-F]{1,4}){1,6}|:(?:(?::[0-9a-fA-F]{1,4}){1,7}|:))(?=\\s|$|[^\\w:])",
          name: "IPV6",
          type: "ipv6",
        },
        phone: {
          pattern:
            "(?:\\+?\\d{1,2}\\s?)?\\(?\\d{3}\\)?[\\s.-]?\\d{3}[\\s.-]?\\d{4}\\b",
          name: "PHONE",
          type: "phone",
        },
        mac: {
          pattern: "\\b(?:[0-9A-Fa-f]{2}[:-]){5}[0-9A-Fa-f]{2}\\b",
          name: "MAC_ADDRESS",
          type: "mac",
        },
      };

      /* =========================
         State Variables
         ========================= */

      let extractedLinks = [];
      let originalSequence = new Map();

      /* =========================
         DOM Elements
         ========================= */

      const textInput = document.getElementById("textInput");
      const fileInput = document.getElementById("fileInput");
      const fileName = document.getElementById("fileName");
      const clearBtn = document.getElementById("clearBtn");
      const copyAllBtn = document.getElementById("copyAllBtn");
      const downloadTxtBtn = document.getElementById("downloadTxtBtn");
      const downloadCsvBtn = document.getElementById("downloadCsvBtn");
      const resultsSection = document.getElementById("resultsSection");
      const linksSection = document.getElementById("linksSection");
      const linksContainer = document.getElementById("linksContainer");
      const totalItemsEl = document.getElementById("totalItems");
      const selectedLinksEl = document.getElementById("selectedLinks");
      const totalLinksEl = document.getElementById("totalLinks");
      const selectedEmailsEl = document.getElementById("selectedEmails");
      const totalEmailsEl = document.getElementById("totalEmails");
      const selectedIPv4El = document.getElementById("selectedIPv4");
      const totalIPv4El = document.getElementById("totalIPv4");
      const selectedIPv6El = document.getElementById("selectedIPv6");
      const totalIPv6El = document.getElementById("totalIPv6");
      const selectedPhoneEl = document.getElementById("selectedPhone");
      const totalPhoneEl = document.getElementById("totalPhone");
      const selectedMACEl = document.getElementById("selectedMAC");
      const totalMACEl = document.getElementById("totalMAC");

      const uniqueItemsEl = document.getElementById("uniqueItems");
      const includeLinksCheckbox = document.getElementById("includeLinks");
      const includeEmailsCheckbox = document.getElementById("includeEmails");
      const includeIPv4Checkbox = document.getElementById("includeIPv4");
      const includeIPv6Checkbox = document.getElementById("includeIPv6");
      const includePhoneCheckbox = document.getElementById("includePhone");
      const includeMACCheckbox = document.getElementById("includeMAC");

      const removeDuplicatesCheckbox =
        document.getElementById("removeDuplicates");
      const sortBySelect = document.getElementById("sortBy");

      /* =========================
         State Variables for Extracted Data
         ========================= */

      let allExtractedItems = []; // All items extracted from text (never filtered)

      /* =========================
         Utility Functions
         ========================= */

      /**
       * Extract ALL patterns from text (always extracts everything)
       */
      function extractAllPatterns(text) {
        const found = [];

        // Extract URLs - create fresh regex each time
        const urlRegex = new RegExp(PATTERNS.url.pattern, "g");
        const urlMatches = text.matchAll(urlRegex);
        for (const match of urlMatches) {
          found.push({
            value: match[0],
            position: match.index,
            type: PATTERNS.url.type,
          });
        }

        // Extract Emails - create fresh regex each time
        const emailRegex = new RegExp(PATTERNS.email.pattern, "g");
        const emailMatches = text.matchAll(emailRegex);
        for (const match of emailMatches) {
          found.push({
            value: match[0],
            position: match.index,
            type: PATTERNS.email.type,
          });
        }

        // Extract IPv4 - create fresh regex each time
        const ipv4Regex = new RegExp(PATTERNS.ipv4.pattern, "g");
        const ipv4Matches = text.matchAll(ipv4Regex);
        for (const match of ipv4Matches) {
          found.push({
            value: match[0],
            position: match.index,
            type: PATTERNS.ipv4.type,
          });
        }

        // Extract IPv6 - create fresh regex each time
        const ipv6Regex = new RegExp(PATTERNS.ipv6.pattern, "g");
        const ipv6Matches = text.matchAll(ipv6Regex);
        for (const match of ipv6Matches) {
          found.push({
            value: match[0],
            position: match.index,
            type: PATTERNS.ipv6.type,
          });
        }

        // Extract Phone - create fresh regex each time
        const phoneRegex = new RegExp(PATTERNS.phone.pattern, "g");
        const phoneMatches = text.matchAll(phoneRegex);
        for (const match of phoneMatches) {
          found.push({
            value: match[0],
            position: match.index,
            type: PATTERNS.phone.type,
          });
        }

        // Extract MAC - create fresh regex each time
        const macRegex = new RegExp(PATTERNS.mac.pattern, "g");
        const macMatches = text.matchAll(macRegex);
        for (const match of macMatches) {
          found.push({
            value: match[0],
            position: match.index,
            type: PATTERNS.mac.type,
          });
        }

        // Sort by position to maintain document order
        found.sort((a, b) => a.position - b.position);

        // Assign original sequence numbers
        found.forEach((item, index) => {
          item.originalSequence = index + 1;
        });

        return found;
      }

      /**
       * Filter items based on user selections
       */
      function filterItems(allItems, options) {
        return allItems.filter((item) => {
          if (item.type === "link" && !options.includeLinks) return false;
          if (item.type === "email" && !options.includeEmails) return false;
          if (item.type === "ipv4" && !options.includeIPv4) return false;
          if (item.type === "ipv6" && !options.includeIPv6) return false;
          if (item.type === "phone" && !options.includePhone) return false;
          if (item.type === "mac" && !options.includeMAC) return false;

          return true;
        });
      }

      /**
       * Process links based on options
       */
      function processLinks(
        items,
        removeDuplicates = false,
        sortBy = "sequence"
      ) {
        let processed = [...items];

        // Add protocol to links starting with www
        processed = processed.map((item) => {
          if (item.type === "link" && item.value.startsWith("www.")) {
            return { ...item, value: "http://" + item.value };
          }
          return item;
        });

        // Remove duplicates
        if (removeDuplicates) {
          const seen = new Set();
          processed = processed.filter((item) => {
            const key = item.value.toLowerCase();
            if (seen.has(key)) {
              return false;
            }
            seen.add(key);
            return true;
          });
        }

        // Sort based on sortBy option
        if (sortBy === "type") {
          processed.sort((a, b) => {
            const typeCompare = a.type.localeCompare(b.type);
            if (typeCompare !== 0) return typeCompare;
            // Secondary sort by value
            return a.value.toLowerCase().localeCompare(b.value.toLowerCase());
          });
        } else if (sortBy === "value") {
          processed.sort((a, b) =>
            a.value.toLowerCase().localeCompare(b.value.toLowerCase())
          );
        } else {
          // Sort by sequence (default)
          processed.sort((a, b) => a.originalSequence - b.originalSequence);
        }

        return processed;
      }

      /**
       * Get display name for type
       */
      function getTypeName(type) {
        const typeMap = {
          link: "URL",
          email: "Email",
          ipv4: "IPv4",
          ipv6: "IPv6",
          phone: "Phone",
          mac: "MAC",
        };
        return typeMap[type] || type;
      }

      /**
       * Display extracted links in a table
       */
      function displayLinks(items) {
        linksContainer.innerHTML = "";

        if (items.length === 0) {
          linksContainer.innerHTML =
            '<div class="empty-state">No items found in the text.</div>';
          return;
        }

        const table = document.createElement("table");
        table.className = "links-table";

        // Create header
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");

        const headers = ["Seq", "Type", "Value", "Actions"];
        headers.forEach((headerText) => {
          const th = document.createElement("th");
          th.textContent = headerText;
          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Create body
        const tbody = document.createElement("tbody");

        items.forEach((item, index) => {
          const row = document.createElement("tr");

          // Sequence number
          const seqCell = document.createElement("td");
          seqCell.textContent = item.originalSequence;
          row.appendChild(seqCell);

          // Type
          const typeCell = document.createElement("td");
          typeCell.className = "link-type";
          typeCell.textContent = getTypeName(item.type);
          row.appendChild(typeCell);

          // Value
          const valueCell = document.createElement("td");
          valueCell.className = "link-url";
          valueCell.textContent = item.value;
          row.appendChild(valueCell);

          // Actions
          const actionsCell = document.createElement("td");
          const linkActions = document.createElement("div");
          linkActions.className = "link-actions";

          const openBtn = document.createElement("button");
          openBtn.textContent = "Open";
          openBtn.onclick = () => {
            if (item.type === "email") {
              window.open(`mailto:${item.value}`, "_blank");
            } else if (item.type === "link") {
              window.open(item.value, "_blank");
            } else {
              // For other types, copy to clipboard
              copyToClipboard(
                item.value,
                `${getTypeName(item.type)} copied to clipboard`
              );
            }
          };

          linkActions.appendChild(openBtn);
          actionsCell.appendChild(linkActions);
          row.appendChild(actionsCell);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        linksContainer.appendChild(table);
      }

      /**
       * Update statistics
       */
      function updateStats(allItems, selectedItems) {
        // Count total items by type
        const totalLinkCount = allItems.filter(
          (item) => item.type === "link"
        ).length;
        const totalEmailCount = allItems.filter(
          (item) => item.type === "email"
        ).length;
        const totalIpv4Count = allItems.filter(
          (item) => item.type === "ipv4"
        ).length;
        const totalIpv6Count = allItems.filter(
          (item) => item.type === "ipv6"
        ).length;
        const totalPhoneCount = allItems.filter(
          (item) => item.type === "phone"
        ).length;
        const totalMacCount = allItems.filter(
          (item) => item.type === "mac"
        ).length;

        // Count selected items by type
        const selectedLinkCount = selectedItems.filter(
          (item) => item.type === "link"
        ).length;
        const selectedEmailCount = selectedItems.filter(
          (item) => item.type === "email"
        ).length;
        const selectedIpv4Count = selectedItems.filter(
          (item) => item.type === "ipv4"
        ).length;
        const selectedIpv6Count = selectedItems.filter(
          (item) => item.type === "ipv6"
        ).length;
        const selectedPhoneCount = selectedItems.filter(
          (item) => item.type === "phone"
        ).length;
        const selectedMacCount = selectedItems.filter(
          (item) => item.type === "mac"
        ).length;

        // Calculate unique items count (regardless of remove duplicates setting)
        const uniqueValues = new Set(
          allItems.map((item) => item.value.toLowerCase())
        );
        const uniqueCount = uniqueValues.size;

        // Update display
        totalItemsEl.textContent = allItems.length;

        selectedLinksEl.textContent = selectedLinkCount;
        totalLinksEl.textContent = totalLinkCount;

        selectedEmailsEl.textContent = selectedEmailCount;
        totalEmailsEl.textContent = totalEmailCount;

        selectedIPv4El.textContent = selectedIpv4Count;
        totalIPv4El.textContent = totalIpv4Count;

        selectedIPv6El.textContent = selectedIpv6Count;
        totalIPv6El.textContent = totalIpv6Count;

        selectedPhoneEl.textContent = selectedPhoneCount;
        totalPhoneEl.textContent = totalPhoneCount;

        selectedMACEl.textContent = selectedMacCount;
        totalMACEl.textContent = totalMacCount;

        uniqueItemsEl.textContent = uniqueCount;
      }

      /**
       * Copy text to clipboard
       */
      function copyToClipboard(text, message = "Copied to clipboard") {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            showNotification(message);
          })
          .catch((err) => {
            console.error("Failed to copy:", err);
            showNotification("Failed to copy", "error");
          });
      }

      /**
       * Show notification
       */
      function showNotification(message, type = "success") {
        const notification = document.createElement("div");
        notification.className = "notification";
        if (type === "error") {
          notification.classList.add("error");
        }
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      /**
       * Download links as text file
       */
      function downloadLinksAsTxt(items) {
        const content = items.map((item) => item.value).join("\n");
        const blob = new Blob([content], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `extracted-items-${Date.now()}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        showNotification("Text file downloaded successfully");
      }

      /**
       * Download links as CSV file
       */
      function downloadLinksAsCsv(items) {
        // Create CSV header
        let csv = "Sequence,Type,Value\n";

        // Add data rows
        items.forEach((item) => {
          const seq = item.originalSequence;
          const type = getTypeName(item.type);
          const value = `"${item.value.replace(/"/g, '""')}"`;
          csv += `${seq},${type},${value}\n`;
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `extracted-items-${Date.now()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showNotification("CSV file downloaded successfully");
      }

      /* =========================
         Event Handlers
         ========================= */

      /**
       * Extract and display links (called when text changes)
       */
      function extractAndDisplay() {
        // Force a fresh read of the textarea value
        const text = document.getElementById("textInput").value;

        if (!text || text.trim() === "") {
          allExtractedItems = [];
          extractedLinks = [];
          resultsSection.classList.add("hidden");
          linksSection.classList.add("hidden");
          // Clear the display
          linksContainer.innerHTML =
            '<div class="empty-state">No items found in the text.</div>';
          return;
        }

        // Reset state before extraction
        allExtractedItems = [];

        // Extract ALL items from text (this happens once per text change)
        allExtractedItems = extractAllPatterns(text);

        // Now filter and display based on current settings
        updateDisplay();

        // Show results section
        resultsSection.classList.remove("hidden");
        linksSection.classList.remove("hidden");
      }

      /**
       * Update display with current filter options (does NOT re-extract)
       */
      function updateDisplay() {
        const options = {
          includeLinks: includeLinksCheckbox.checked,
          includeEmails: includeEmailsCheckbox.checked,
          includeIPv4: includeIPv4Checkbox.checked,
          includeIPv6: includeIPv6Checkbox.checked,
          includePhone: includePhoneCheckbox.checked,
          includeMAC: includeMACCheckbox.checked,
        };
        const removeDuplicates = removeDuplicatesCheckbox.checked;
        const sortBy = sortBySelect.value;

        // Filter items based on checkboxes
        const filteredItems = filterItems(allExtractedItems, options);

        // Process items (remove duplicates, sort)
        extractedLinks = processLinks(filteredItems, removeDuplicates, sortBy);

        // Always display results and update stats (even if empty)
        displayLinks(extractedLinks);
        updateStats(allExtractedItems, extractedLinks);

        // Hide/show sections based on whether we have items
        if (allExtractedItems.length === 0) {
          resultsSection.classList.add("hidden");
          linksSection.classList.add("hidden");
        } else {
          resultsSection.classList.remove("hidden");
          linksSection.classList.remove("hidden");
        }
      }

      /**
       * Handle file reading
       */
      function handleFile(file) {
        fileName.textContent = file.name;

        const reader = new FileReader();
        reader.onload = (e) => {
          textInput.value = e.target.result;
          extractAndDisplay();
        };
        reader.onerror = () => {
          showNotification("Failed to read file", "error");
        };
        reader.readAsText(file);
      }

      // Clear button
      clearBtn.addEventListener("click", () => {
        textInput.value = "";
        fileName.textContent = "";
        extractedLinks = [];
        allExtractedItems = [];
        resultsSection.classList.add("hidden");
        linksSection.classList.add("hidden");
        textInput.focus();
      });

      // Copy all button
      copyAllBtn.addEventListener("click", () => {
        if (extractedLinks.length === 0) {
          showNotification("No items to copy", "error");
          return;
        }

        const allLinks = extractedLinks.map((item) => item.value).join("\n");
        copyToClipboard(allLinks, "All items copied to clipboard");
      });

      // Download as text button
      downloadTxtBtn.addEventListener("click", () => {
        if (extractedLinks.length === 0) {
          showNotification("No items to download", "error");
          return;
        }

        downloadLinksAsTxt(extractedLinks);
      });

      // Download as CSV button
      downloadCsvBtn.addEventListener("click", () => {
        if (extractedLinks.length === 0) {
          showNotification("No items to download", "error");
          return;
        }

        downloadLinksAsCsv(extractedLinks);
      });

      // File input change
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          handleFile(file);
        }
      });

      // Auto-extract on input change - use multiple events to ensure it fires
      const handleTextChange = () => {
        // Use requestAnimationFrame to ensure DOM has updated
        requestAnimationFrame(() => {
          extractAndDisplay();
        });
      };

      textInput.addEventListener("input", handleTextChange);
      textInput.addEventListener("keyup", handleTextChange);
      textInput.addEventListener("change", handleTextChange);
      textInput.addEventListener("paste", () => {
        setTimeout(handleTextChange, 10);
      });
      textInput.addEventListener("cut", () => {
        setTimeout(handleTextChange, 10);
      });

      // Update display when checkboxes change
      includeLinksCheckbox.addEventListener("change", updateDisplay);
      includeEmailsCheckbox.addEventListener("change", updateDisplay);
      includeIPv4Checkbox.addEventListener("change", updateDisplay);
      includeIPv6Checkbox.addEventListener("change", updateDisplay);
      includePhoneCheckbox.addEventListener("change", updateDisplay);
      includeMACCheckbox.addEventListener("change", updateDisplay);
      removeDuplicatesCheckbox.addEventListener("change", updateDisplay);
      sortBySelect.addEventListener("change", updateDisplay);

      // Initialization
      textInput.focus();
    </script>
  </body>
</html>
