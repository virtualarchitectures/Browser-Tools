<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transcription Tool</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: Helvetica, Arial, sans-serif;
        line-height: 1.6;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        color: #24292e;
        background: #ffffff;
      }

      h1 {
        border-bottom: 1px solid #eaecef;
        padding-bottom: 0.3em;
        margin-top: 0;
        font-size: 32px;
        font-weight: 600;
      }

      .back-link {
        display: inline-block;
        margin-bottom: 16px;
        color: #0366d6;
        text-decoration: none;
        font-size: 14px;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-top: 24px;
        grid-auto-rows: auto;
        align-items: start;
      }

      @media (min-width: 768px) {
        .main-content {
          grid-template-columns: 400px 1fr;
        }
      }

      .media-panel {
        background: #f6f8fa;
        border-radius: 6px;
        padding: 16px;
        border: 1px solid #e1e4e8;
        height: fit-content;
        margin-bottom: 16px;
      }

      .media-panel h2 {
        margin: 0 0 12px 0;
        font-size: 16px;
        font-weight: 600;
        color: #24292e;
      }

      .file-input-section {
        margin-bottom: 16px;
      }

      .file-input-section label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 600;
        color: #24292e;
      }

      .file-input-wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
      }

      .file-input-button {
        display: block;
        width: 100%;
        padding: 8px 12px;
        background: #0366d6;
        color: white;
        border: 1px solid rgba(27, 31, 35, 0.15);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        line-height: 20px;
        font-family: Helvetica, Arial, sans-serif;
        transition: background 0.2s;
      }

      .file-input-button:hover {
        background: #0256c5;
      }

      input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        top: 0;
        left: 0;
      }

      input[type="text"],
      input[type="url"],
      textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        font-size: 14px;
        font-family: Helvetica, Arial, sans-serif;
        background: #ffffff;
        color: #24292e;
      }

      input[type="text"]:focus,
      input[type="url"]:focus,
      textarea:focus {
        outline: none;
        border-color: #0366d6;
      }

      .youtube-section {
        margin-bottom: 16px;
      }

      .youtube-input-group {
        display: flex;
        gap: 8px;
      }

      .youtube-input-group input {
        flex: 1;
      }

      .youtube-input-group button {
        padding: 8px 12px;
        background: #0366d6;
        color: white;
        border: 1px solid rgba(27, 31, 35, 0.15);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        line-height: 20px;
        font-family: Helvetica, Arial, sans-serif;
        white-space: nowrap;
      }

      .youtube-input-group button:hover {
        background: #0256c5;
      }

      .media-container {
        margin-bottom: 16px;
        background: #000;
        border-radius: 6px;
        overflow: hidden;
        border: 1px solid #e1e4e8;
      }

      #media-player,
      #youtube-player {
        width: 100%;
        height: auto;
        display: block;
      }

      #youtube-player {
        aspect-ratio: 16 / 9;
      }

      .media-container.hidden {
        display: none;
      }

      .controls {
        margin-bottom: 16px;
      }

      .control-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      .control-buttons button {
        flex: 1;
        min-width: 80px;
        padding: 8px 12px;
        background: #fafbfc;
        color: #24292e;
        border: 1px solid rgba(27, 31, 35, 0.15);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        line-height: 20px;
        font-family: Helvetica, Arial, sans-serif;
        transition: background 0.2s;
      }

      .control-buttons button:hover {
        background: #f3f4f6;
      }

      .control-buttons button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .speed-control {
        margin-bottom: 12px;
      }

      .speed-control label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 14px;
        color: #24292e;
        font-weight: 600;
      }

      input[type="range"] {
        width: 100%;
        cursor: pointer;
      }

      .time-display {
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        padding: 12px;
        background: #ffffff;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        margin-bottom: 12px;
        color: #24292e;
      }

      .keyboard-shortcuts {
        background: #ffffff;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #e1e4e8;
        font-size: 13px;
        line-height: 1.6;
      }

      .keyboard-shortcuts h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
        font-weight: 600;
        color: #24292e;
      }

      .keyboard-shortcuts ul {
        margin: 0;
        padding-left: 20px;
      }

      .keyboard-shortcuts li {
        margin-bottom: 5px;
      }

      .keyboard-shortcuts code {
        background: #f6f8fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo,
          monospace;
        font-size: 12px;
        border: 1px solid #e1e4e8;
      }

      .transcript-panel {
        background: transparent;
        border-radius: 6px;
        padding: 0;
        border: 1px solid #e1e4e8;
        display: flex;
        flex-direction: column;
        min-width: 0;
        height: fit-content;
      }

      .transcript-toolbar {
        padding: 12px 16px;
        border-bottom: 1px solid #e1e4e8;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        background: #ffffff;
        border-radius: 6px 6px 0 0;
      }

      .transcript-toolbar button {
        padding: 8px 12px;
        background: #fafbfc;
        color: #24292e;
        border: 1px solid rgba(27, 31, 35, 0.15);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        line-height: 20px;
        font-family: Helvetica, Arial, sans-serif;
        transition: background 0.2s;
      }

      .transcript-toolbar button:hover {
        background: #f3f4f6;
      }

      .word-count {
        margin-left: auto;
        padding: 8px 12px;
        background: #f6f8fa;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        color: #24292e;
      }

      #transcript-editor {
        padding: 16px;
        font-size: 14px;
        line-height: 1.8;
        overflow-y: auto;
        overflow-x: hidden;
        overflow-wrap: break-word;
        word-wrap: break-word;
        white-space: pre-wrap;
        word-break: break-word;
        outline: none;
        min-height: 250px;
        height: 600px;
        min-width: 0;
        width: 100%;
        background: #ffffff;
        color: #24292e;
        resize: vertical;
      }

      #transcript-editor:empty:before {
        content: "Start typing your transcript here...";
        color: #586069;
      }

      .timestamp {
        display: inline-block;
        background: #0366d6;
        color: white;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        margin: 0 4px;
        user-select: none;
        font-weight: 600;
      }

      .timestamp:hover {
        background: #0256c5;
      }

      .export-toolbar {
        padding: 12px 16px;
        border-top: 1px solid #e1e4e8;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        background: #ffffff;
        border-radius: 0 0 6px 6px;
      }

      .export-toolbar button {
        padding: 8px 12px;
        background: #0366d6;
        color: white;
        border: 1px solid rgba(27, 31, 35, 0.15);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        line-height: 20px;
        font-family: Helvetica, Arial, sans-serif;
        transition: background 0.2s;
      }

      .export-toolbar button:hover {
        background: #0256c5;
      }

      .current-file {
        padding: 12px;
        background: #f6f8fa;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        font-size: 13px;
        margin-bottom: 12px;
        word-break: break-all;
        color: #586069;
        transition: background 0.2s, border-color 0.2s, color 0.2s;
      }

      .current-file.success {
        background: #d1f4e0;
        border-color: #28a745;
        color: #24292e;
      }

      .current-file.hidden {
        display: none;
      }

      @media (max-width: 767px) {
        .container {
          padding: 10px;
        }

        h1 {
          font-size: 24px;
        }

        .main-content {
          gap: 15px;
          margin-top: 15px;
        }

        .media-panel,
        .transcript-panel {
          padding: 15px;
        }

        .control-buttons {
          flex-direction: column;
        }

        .control-buttons button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <a href="index.html" class="back-link">← Back to Browser Tools</a>

    <h1>Transcription Tool</h1>

    <div class="container">
      <div class="main-content">
        <div class="media-panel">
          <h2>Media</h2>

          <div class="file-input-section">
            <label>Upload Audio/Video File:</label>
            <div class="file-input-wrapper">
              <button class="file-input-button" type="button">
                Choose File
              </button>
              <input type="file" id="file-input" accept="audio/*,video/*" />
            </div>
          </div>

          <div class="youtube-section">
            <label>Or load YouTube video:</label>
            <div class="youtube-input-group">
              <input
                type="url"
                id="youtube-url"
                placeholder="https://www.youtube.com/watch?v=..."
              />
              <button id="load-youtube">Load</button>
            </div>
          </div>

          <div class="current-file hidden" id="current-file"></div>

          <div class="media-container hidden" id="media-container">
            <video id="media-player" controls></video>
          </div>

          <div class="media-container hidden" id="youtube-container">
            <div id="youtube-player"></div>
          </div>

          <div class="controls">
            <div class="time-display" id="time-display">0:00 / 0:00</div>

            <div class="control-buttons">
              <button id="play-pause" disabled>Play</button>
              <button id="rewind" disabled>-5s</button>
              <button id="forward" disabled>+5s</button>
            </div>

            <div class="speed-control">
              <label>
                <span>Speed: <span id="speed-value">1.0</span>x</span>
              </label>
              <input
                type="range"
                id="speed-slider"
                min="0.5"
                max="2.0"
                step="0.25"
                value="1.0"
                disabled
              />
            </div>
          </div>

          <div class="keyboard-shortcuts">
            <h3>Keyboard Shortcuts:</h3>
            <ul>
              <li><code>ESC</code> - Play/Pause</li>
              <li><code>Ctrl+J</code> - Insert timestamp</li>
              <li><code>Ctrl+←</code> - Rewind 5s</li>
              <li><code>Ctrl+→</code> - Forward 5s</li>
              <li><code>Ctrl+↑</code> - Speed up</li>
              <li><code>Ctrl+↓</code> - Speed down</li>
              <li><code>Ctrl+B</code> - Bold</li>
              <li><code>Ctrl+I</code> - Italic</li>
              <li><code>Ctrl+S</code> - Save</li>
            </ul>
          </div>
        </div>

        <div class="transcript-panel">
          <div class="transcript-toolbar">
            <button id="bold-btn" title="Bold (Ctrl+B)">
              <b>B</b>
            </button>
            <button id="italic-btn" title="Italic (Ctrl+I)">
              <i>I</i>
            </button>
            <button id="timestamp-btn" title="Insert Timestamp (Ctrl+J)">
              ⏱ Timestamp
            </button>
            <button id="clear-btn" title="Clear transcript">Clear</button>
            <div class="word-count">Words: <span id="word-count">0</span></div>
          </div>

          <div id="transcript-editor" contenteditable="true"></div>

          <div class="export-toolbar">
            <button id="export-txt">Export as Text</button>
            <button id="export-md">Export as Markdown</button>
            <button id="save-btn">Save</button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      let mediaElement = null;
      let youtubePlayer = null;
      let isYouTube = false;
      let autoSaveInterval = null;

      const elements = {
        fileInput: document.getElementById("file-input"),
        youtubeUrl: document.getElementById("youtube-url"),
        loadYoutubeBtn: document.getElementById("load-youtube"),
        currentFile: document.getElementById("current-file"),
        mediaContainer: document.getElementById("media-container"),
        youtubeContainer: document.getElementById("youtube-container"),
        mediaPlayer: document.getElementById("media-player"),
        playPauseBtn: document.getElementById("play-pause"),
        rewindBtn: document.getElementById("rewind"),
        forwardBtn: document.getElementById("forward"),
        speedSlider: document.getElementById("speed-slider"),
        speedValue: document.getElementById("speed-value"),
        timeDisplay: document.getElementById("time-display"),
        transcriptEditor: document.getElementById("transcript-editor"),
        boldBtn: document.getElementById("bold-btn"),
        italicBtn: document.getElementById("italic-btn"),
        timestampBtn: document.getElementById("timestamp-btn"),
        clearBtn: document.getElementById("clear-btn"),
        wordCount: document.getElementById("word-count"),
        exportTxt: document.getElementById("export-txt"),
        exportMd: document.getElementById("export-md"),
        saveBtn: document.getElementById("save-btn"),
      };

      // Load YouTube IFrame API
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName("script")[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // Initialize from localStorage
      function loadFromStorage() {
        const saved = localStorage.getItem("transcript");
        if (saved) {
          elements.transcriptEditor.innerHTML = saved;
          updateWordCount();
        }
      }

      // Save to localStorage
      function saveToStorage() {
        localStorage.setItem("transcript", elements.transcriptEditor.innerHTML);
        showStatus("Transcript saved!");
      }

      // Auto-save every 5 seconds
      function startAutoSave() {
        if (autoSaveInterval) {
          clearInterval(autoSaveInterval);
        }
        autoSaveInterval = setInterval(() => {
          localStorage.setItem(
            "transcript",
            elements.transcriptEditor.innerHTML
          );
        }, 5000);
      }

      // Show status message in current file area
      function showStatus(message, temporary = true) {
        elements.currentFile.textContent = message;
        elements.currentFile.classList.remove("hidden");
        elements.currentFile.classList.add("success");

        if (temporary) {
          setTimeout(() => {
            elements.currentFile.classList.remove("success");
            // Reset to show current file if media is loaded
            if (mediaElement && mediaElement.src) {
              const fileName =
                elements.currentFile.getAttribute("data-filename");
              if (fileName) {
                elements.currentFile.textContent = `Current file: ${fileName}`;
              } else {
                elements.currentFile.classList.add("hidden");
              }
            } else if (isYouTube && youtubePlayer) {
              elements.currentFile.textContent = "Current: YouTube video";
            } else {
              elements.currentFile.classList.add("hidden");
            }
          }, 2000);
        }
      }

      // Format time in MM:SS or HH:MM:SS
      function formatTime(seconds) {
        if (isNaN(seconds)) return "0:00";

        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);

        if (hours > 0) {
          return `${hours}:${minutes.toString().padStart(2, "0")}:${secs
            .toString()
            .padStart(2, "0")}`;
        }
        return `${minutes}:${secs.toString().padStart(2, "0")}`;
      }

      // Parse time string to seconds
      function parseTime(timeStr) {
        const parts = timeStr.split(":").map((p) => parseInt(p, 10));
        if (parts.length === 2) {
          return parts[0] * 60 + parts[1];
        } else if (parts.length === 3) {
          return parts[0] * 3600 + parts[1] * 60 + parts[2];
        }
        return 0;
      }

      // Update time display
      function updateTimeDisplay() {
        let currentTime = 0;
        let duration = 0;

        if (isYouTube && youtubePlayer) {
          currentTime = youtubePlayer.getCurrentTime();
          duration = youtubePlayer.getDuration();
        } else if (mediaElement) {
          currentTime = mediaElement.currentTime;
          duration = mediaElement.duration;
        }

        elements.timeDisplay.textContent = `${formatTime(
          currentTime
        )} / ${formatTime(duration)}`;
      }

      // Get current time
      function getCurrentTime() {
        if (isYouTube && youtubePlayer) {
          return youtubePlayer.getCurrentTime();
        } else if (mediaElement) {
          return mediaElement.currentTime;
        }
        return 0;
      }

      // Set current time
      function setCurrentTime(time) {
        if (isYouTube && youtubePlayer) {
          youtubePlayer.seekTo(time, true);
        } else if (mediaElement) {
          mediaElement.currentTime = time;
        }
      }

      // Play/Pause
      function togglePlayPause() {
        if (isYouTube && youtubePlayer) {
          const state = youtubePlayer.getPlayerState();
          if (state === 1) {
            // Playing
            youtubePlayer.pauseVideo();
          } else {
            youtubePlayer.playVideo();
          }
        } else if (mediaElement) {
          if (mediaElement.paused) {
            mediaElement.play();
          } else {
            mediaElement.pause();
          }
        }
      }

      // Update play/pause button text
      function updatePlayPauseButton() {
        if (isYouTube && youtubePlayer) {
          const state = youtubePlayer.getPlayerState();
          elements.playPauseBtn.textContent = state === 1 ? "Pause" : "Play";
        } else if (mediaElement) {
          elements.playPauseBtn.textContent = mediaElement.paused
            ? "Play"
            : "Pause";
        }
      }

      // Set playback speed
      function setPlaybackSpeed(speed) {
        if (isYouTube && youtubePlayer) {
          youtubePlayer.setPlaybackRate(speed);
        } else if (mediaElement) {
          mediaElement.playbackRate = speed;
        }
      }

      // Enable controls
      function enableControls() {
        elements.playPauseBtn.disabled = false;
        elements.rewindBtn.disabled = false;
        elements.forwardBtn.disabled = false;
        elements.speedSlider.disabled = false;
      }

      // Handle file upload
      elements.fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Clear YouTube
        isYouTube = false;
        elements.youtubeContainer.classList.add("hidden");
        if (youtubePlayer) {
          youtubePlayer.stopVideo();
        }

        // Show media container
        elements.mediaContainer.classList.remove("hidden");

        const url = URL.createObjectURL(file);
        mediaElement = elements.mediaPlayer;

        // Detect if video or audio
        if (file.type.startsWith("video/")) {
          mediaElement.src = url;
        } else {
          mediaElement.src = url;
        }

        elements.currentFile.textContent = `Current file: ${file.name}`;
        elements.currentFile.setAttribute("data-filename", file.name);
        elements.currentFile.classList.remove("hidden");

        enableControls();
        showStatus("Media file loaded!");
      });

      // Load YouTube video
      window.onYouTubeIframeAPIReady = function () {
        console.log("YouTube API ready");
      };

      elements.loadYoutubeBtn.addEventListener("click", () => {
        const url = elements.youtubeUrl.value.trim();
        if (!url) return;

        // Extract video ID
        let videoId = "";
        try {
          const urlObj = new URL(url);
          if (urlObj.hostname.includes("youtube.com")) {
            videoId = urlObj.searchParams.get("v");
          } else if (urlObj.hostname.includes("youtu.be")) {
            videoId = urlObj.pathname.slice(1);
          }
        } catch (e) {
          showStatus("Invalid YouTube URL", false);
          return;
        }

        if (!videoId) {
          showStatus("Could not extract video ID", false);
          return;
        }

        // Clear local media
        elements.mediaContainer.classList.add("hidden");
        if (mediaElement) {
          mediaElement.pause();
          mediaElement.src = "";
        }

        // Show YouTube container
        elements.youtubeContainer.classList.remove("hidden");
        isYouTube = true;

        // Create or update YouTube player
        if (youtubePlayer) {
          youtubePlayer.loadVideoById(videoId);
        } else {
          youtubePlayer = new YT.Player("youtube-player", {
            videoId: videoId,
            playerVars: {
              playsinline: 1,
            },
            events: {
              onReady: (event) => {
                enableControls();
                elements.currentFile.textContent = "Current: YouTube video";
                elements.currentFile.classList.remove("hidden");

                showStatus("YouTube video loaded!");

                // Start time update interval
                setInterval(updateTimeDisplay, 500);
              },
              onStateChange: (event) => {
                updatePlayPauseButton();
              },
            },
          });
        }
      });

      // Play/Pause button
      elements.playPauseBtn.addEventListener("click", togglePlayPause);

      // Rewind button
      elements.rewindBtn.addEventListener("click", () => {
        const currentTime = getCurrentTime();
        setCurrentTime(Math.max(0, currentTime - 5));
      });

      // Forward button
      elements.forwardBtn.addEventListener("click", () => {
        const currentTime = getCurrentTime();
        setCurrentTime(currentTime + 5);
      });

      // Speed slider
      elements.speedSlider.addEventListener("input", (e) => {
        const speed = parseFloat(e.target.value);
        elements.speedValue.textContent = speed.toFixed(2);
        setPlaybackSpeed(speed);
      });

      // Media player events
      elements.mediaPlayer.addEventListener("timeupdate", updateTimeDisplay);
      elements.mediaPlayer.addEventListener("play", updatePlayPauseButton);
      elements.mediaPlayer.addEventListener("pause", updatePlayPauseButton);

      // Insert timestamp
      function insertTimestamp() {
        const currentTime = getCurrentTime();
        const timeStr = formatTime(currentTime);

        const timestamp = document.createElement("span");
        timestamp.className = "timestamp";
        timestamp.textContent = timeStr;
        timestamp.setAttribute("data-time", currentTime.toString());
        timestamp.contentEditable = "false";

        // Insert at cursor
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);

          // Save the current cursor position
          const cursorNode = range.startContainer;
          const cursorOffset = range.startOffset;

          // Insert timestamp before cursor
          range.insertNode(timestamp);

          // Add a space after the timestamp
          const space = document.createTextNode(" ");
          timestamp.parentNode.insertBefore(space, timestamp.nextSibling);

          // Restore cursor position after the space
          const newRange = document.createRange();
          newRange.setStart(space, 1);
          newRange.setEnd(space, 1);
          selection.removeAllRanges();
          selection.addRange(newRange);
        } else {
          elements.transcriptEditor.appendChild(timestamp);
          elements.transcriptEditor.appendChild(document.createTextNode(" "));
        }

        elements.transcriptEditor.focus();
        updateWordCount();
      }

      // Click timestamp to jump
      elements.transcriptEditor.addEventListener("click", (e) => {
        if (e.target.classList.contains("timestamp")) {
          const time = parseFloat(e.target.getAttribute("data-time"));
          setCurrentTime(time);
        }
      });

      // Toolbar buttons
      elements.boldBtn.addEventListener("click", () => {
        document.execCommand("bold", false, null);
        elements.transcriptEditor.focus();
      });

      elements.italicBtn.addEventListener("click", () => {
        document.execCommand("italic", false, null);
        elements.transcriptEditor.focus();
      });

      elements.timestampBtn.addEventListener("click", insertTimestamp);

      elements.clearBtn.addEventListener("click", () => {
        if (confirm("Are you sure you want to clear the transcript?")) {
          elements.transcriptEditor.innerHTML = "";
          updateWordCount();
          saveToStorage();
        }
      });

      // Update word count
      function updateWordCount() {
        const text = elements.transcriptEditor.innerText.trim();
        const words = text ? text.split(/\s+/).length : 0;
        elements.wordCount.textContent = words;
      }

      // Auto-scroll to keep cursor visible
      function scrollToCursor() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          const rect = range.getBoundingClientRect();
          const editorRect = elements.transcriptEditor.getBoundingClientRect();

          // Check if cursor is below the visible area
          if (rect.bottom > editorRect.bottom - 20) {
            elements.transcriptEditor.scrollTop +=
              rect.bottom - editorRect.bottom + 40;
          }
          // Check if cursor is above the visible area
          else if (rect.top < editorRect.top + 20) {
            elements.transcriptEditor.scrollTop -=
              editorRect.top - rect.top + 40;
          }
        }
      }

      elements.transcriptEditor.addEventListener("input", () => {
        updateWordCount();
        // Delay scroll slightly to ensure DOM is updated
        setTimeout(scrollToCursor, 0);
      });

      elements.transcriptEditor.addEventListener("keydown", () => {
        // Also scroll on keydown for immediate feedback
        setTimeout(scrollToCursor, 0);
      });

      // Export functions
      function getTranscriptText() {
        let text = "";
        const nodes = elements.transcriptEditor.childNodes;

        for (let node of nodes) {
          if (node.nodeType === Node.TEXT_NODE) {
            text += node.textContent;
          } else if (node.nodeType === Node.ELEMENT_NODE) {
            if (node.classList.contains("timestamp")) {
              text += `[${node.textContent}]`;
            } else if (node.tagName === "BR") {
              text += "\n";
            } else if (node.tagName === "DIV" || node.tagName === "P") {
              text += "\n" + node.innerText;
            } else {
              text += node.innerText;
            }
          }
        }

        return text.trim();
      }

      function getTranscriptMarkdown() {
        let markdown = "";
        const html = elements.transcriptEditor.innerHTML;

        // Simple HTML to Markdown conversion
        markdown = html
          .replace(/<b>(.*?)<\/b>/g, "**$1**")
          .replace(/<strong>(.*?)<\/strong>/g, "**$1**")
          .replace(/<i>(.*?)<\/i>/g, "*$1*")
          .replace(/<em>(.*?)<\/em>/g, "*$1*")
          .replace(/<span class="timestamp"[^>]*>(.*?)<\/span>/g, "[$1]")
          .replace(/<div>/g, "\n")
          .replace(/<\/div>/g, "")
          .replace(/<p>/g, "\n")
          .replace(/<\/p>/g, "")
          .replace(/<br\s*\/?>/g, "\n")
          .replace(/<[^>]+>/g, "");

        return markdown.trim();
      }

      elements.exportTxt.addEventListener("click", () => {
        const text = getTranscriptText();
        const blob = new Blob([text], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `transcript-${Date.now()}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        showStatus("Exported as text file!");
      });

      elements.exportMd.addEventListener("click", () => {
        const markdown = getTranscriptMarkdown();
        const blob = new Blob([markdown], { type: "text/markdown" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `transcript-${Date.now()}.md`;
        a.click();
        URL.revokeObjectURL(url);
        showStatus("Exported as Markdown file!");
      });

      elements.saveBtn.addEventListener("click", saveToStorage);

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        // ESC - Play/Pause
        if (e.key === "Escape") {
          e.preventDefault();
          togglePlayPause();
        }

        // Ctrl+J - Insert timestamp
        if (e.ctrlKey && e.key === "j") {
          e.preventDefault();
          insertTimestamp();
        }

        // Ctrl+Left Arrow - Rewind
        if (e.ctrlKey && e.key === "ArrowLeft") {
          e.preventDefault();
          const currentTime = getCurrentTime();
          setCurrentTime(Math.max(0, currentTime - 5));
        }

        // Ctrl+Right Arrow - Forward
        if (e.ctrlKey && e.key === "ArrowRight") {
          e.preventDefault();
          const currentTime = getCurrentTime();
          setCurrentTime(currentTime + 5);
        }

        // Ctrl+Up Arrow - Speed up
        if (e.ctrlKey && e.key === "ArrowUp") {
          e.preventDefault();
          const currentSpeed = parseFloat(elements.speedSlider.value);
          const newSpeed = Math.min(2.0, currentSpeed + 0.25);
          elements.speedSlider.value = newSpeed;
          elements.speedValue.textContent = newSpeed.toFixed(2);
          setPlaybackSpeed(newSpeed);
        }

        // Ctrl+Down Arrow - Speed down
        if (e.ctrlKey && e.key === "ArrowDown") {
          e.preventDefault();
          const currentSpeed = parseFloat(elements.speedSlider.value);
          const newSpeed = Math.max(0.5, currentSpeed - 0.25);
          elements.speedSlider.value = newSpeed;
          elements.speedValue.textContent = newSpeed.toFixed(2);
          setPlaybackSpeed(newSpeed);
        }

        // Ctrl+S - Save
        if (e.ctrlKey && e.key === "s") {
          e.preventDefault();
          saveToStorage();
        }

        // Ctrl+B - Bold
        if (e.ctrlKey && e.key === "b") {
          e.preventDefault();
          if (document.activeElement !== elements.transcriptEditor) {
            elements.transcriptEditor.focus();
          }
          document.execCommand("bold", false, null);
        }

        // Ctrl+I - Italic
        if (e.ctrlKey && e.key === "i") {
          e.preventDefault();
          if (document.activeElement !== elements.transcriptEditor) {
            elements.transcriptEditor.focus();
          }
          document.execCommand("italic", false, null);
        }
      });

      // Initialize
      loadFromStorage();
      startAutoSave();
      updateWordCount();

      console.log("Transcription tool loaded successfully!");
    </script>
  </body>
</html>
